---
import { getRelativeLocaleUrl } from "astro:i18n";
import ThemeToggle from "./ThemeToggle";
import LanguageToggle from "./LanguageToggle.astro";
import { Mode } from "../types";
import { ui, defaultLang } from "../i18n/ui";
import {
    useTranslations,
    getLangFromUrl,
    useTranslatedPath,
} from "../i18n/utils";
import {
    Layers,
    Server,
    Code,
    Terminal,
    Database,
    Bot,
    Volume2,
    VolumeX,
    Menu,
    X,
} from "lucide-react";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

// Get current mode from URL
const { pathname } = Astro.url;
// Identify mode based on path segment after lang
// Assuming structure: /[lang]/[mode] or just /[mode] if lang is default and hidden
const pathSegments = pathname.split("/").filter(Boolean);
// If first segment is a lang, the second might be mode. If not, first might be mode.
const potentialMode = pathSegments[0] in ui ? pathSegments[1] : pathSegments[0];

const currentMode = Object.values(Mode).includes(potentialMode as Mode)
    ? (potentialMode as Mode)
    : Mode.FULLSTACK; // Default or fallback

const isLight = currentMode === Mode.FRONTEND;

const navContainerClasses = isLight
    ? "bg-white/80 backdrop-blur-xl border-b border-gray-200 shadow-sm text-black"
    : "bg-black/60 backdrop-blur-xl border-b border-white/10 text-white";

const logoTextClasses = isLight
    ? "text-black group-hover:text-blue-600"
    : "text-white group-hover:text-brand-400";

const modeButtonBase =
    "relative px-3 py-2 text-xs font-bold rounded-lg transition-all duration-300 uppercase tracking-wider cursor-pointer";
const modeButtonActive = {
    [Mode.FULLSTACK]: "bg-indigo-600 text-white",
    [Mode.BACKEND]:
        "bg-green-600 text-black border-green-400 shadow-[0_0_15px_rgba(34,197,94,0.5)]",
    [Mode.FRONTEND]:
        "bg-pink-500 text-white border-pink-300 shadow-[0_0_15px_rgba(236,72,153,0.5)]",
    [Mode.DEVOPS]:
        "bg-orange-600 text-white border-orange-400 shadow-[0_0_15px_rgba(234,88,12,0.5)]",
    [Mode.DATABASE]:
        "bg-blue-600 text-white border-blue-400 shadow-[0_0_15px_rgba(37,99,235,0.5)]",
    [Mode.AI]:
        "bg-purple-600 text-white border-purple-400 shadow-[0_0_15px_rgba(147,51,234,0.5)]",
};
const modeButtonInactive = isLight
    ? "text-black/60 hover:text-black hover:bg-black/5 opacity-50 hover:opacity-100"
    : "text-white/40 hover:text-white hover:bg-white/5 opacity-50 hover:opacity-100";
---

<nav
    class:list={[
        "fixed top-0 inset-x-0 w-full z-50 transition-all duration-500",
        navContainerClasses,
    ]}
>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
            <!-- Logo -->
            <a
                href={translatePath("/")}
                class="flex items-center gap-2 cursor-pointer group"
            >
                <div class="relative">
                    <!-- Icons would ideally be components or SVG strings. Using simplified placeholders or lucide-react if supported in Astro directly (it is via standard package) -->
                    {
                        currentMode === Mode.FULLSTACK && (
                            <Layers
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    {
                        currentMode === Mode.FRONTEND && (
                            <Code
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    {
                        currentMode === Mode.BACKEND && (
                            <Server
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    {
                        currentMode === Mode.DEVOPS && (
                            <Terminal
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    {
                        currentMode === Mode.DATABASE && (
                            <Database
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    {
                        currentMode === Mode.AI && (
                            <Bot
                                className={`w-8 h-8 relative z-10 transition-transform group-hover:rotate-12 ${isLight ? "text-black" : "text-white"}`}
                            />
                        )
                    }
                    <div
                        class:list={[
                            "absolute inset-0 blur-lg rounded-full",
                            isLight ? "bg-black/10" : "bg-white/30",
                        ]}
                    >
                    </div>
                </div>
                <div class="flex flex-col">
                    <span
                        class:list={[
                            "font-bold text-lg leading-tight tracking-wider transition-colors",
                            logoTextClasses,
                        ]}
                    >
                        JÃ”NATAS<span class="opacity-50">.DEV</span>
                    </span>
                    <span
                        class:list={[
                            "text-[10px] uppercase tracking-[0.2em] opacity-60",
                            isLight ? "text-black" : "text-white",
                        ]}
                    >
                        {t("nav.title")}
                    </span>
                </div>
            </a>

            <!-- Desktop Menu -->
            <div class="hidden lg:flex items-center gap-6">
                <!-- Audio Toggle (Placeholder implementation) -->
                <button
                    id="audio-toggle"
                    class:list={[
                        "p-2 rounded-full transition-all cursor-pointer",
                        isLight
                            ? "text-black/60 hover:bg-black/5"
                            : "text-white/70 hover:bg-white/10",
                    ]}
                    title={t("nav.audio")}
                >
                    <VolumeX className="size-5" />
                </button>

                <!-- Mode Selector -->
                <div
                    class:list={[
                        "flex backdrop-blur-md rounded-xl p-1.5 border",
                        isLight
                            ? "bg-white/50 border-black/5"
                            : "bg-black/30 border-white/10",
                    ]}
                >
                    {
                        Object.values(Mode).map((mode) => (
                            <a
                                href={translatePath(`/${mode}`)}
                                class:list={[
                                    modeButtonBase,
                                    currentMode === mode
                                        ? modeButtonActive[mode]
                                        : modeButtonInactive,
                                ]}
                            >
                                {mode}
                            </a>
                        ))
                    }
                </div>

                <!-- Theme Toggle -->
                <div class="flex items-center gap-4">
                    <ThemeToggle client:load locale={lang} />
                </div>

                <!-- Language Selector -->
                <div
                    class:list={[
                        "flex items-center gap-2 text-sm",
                        isLight ? "text-black/60" : "text-white/50",
                    ]}
                >
                    <LanguageToggle currentLocale={lang} />
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <div class="lg:hidden">
                <button
                    id="mobile-menu-btn"
                    class:list={[
                        "p-2 cursor-pointer",
                        isLight ? "text-black" : "text-white",
                    ]}
                    aria-label="Toggle menu"
                >
                    <Menu className="size-6" />
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Content -->
    <div
        id="mobile-menu"
        class:list={[
            "hidden lg:hidden p-6 fixed inset-0 top-20 z-40 overflow-y-auto",
            isLight
                ? "bg-white/95 border-b border-black/5"
                : "bg-black/95 border-b border-white/10",
        ]}
    >
        <div
            class:list={[
                "text-center py-10",
                isLight ? "text-black" : "text-white",
            ]}
        >
            <!-- Mobile Mode Links -->
            <div class="flex flex-col gap-4">
                {
                    Object.values(Mode).map((mode) => (
                        <a
                            href={translatePath(`/${mode}`)}
                            class:list={[
                                "p-4 rounded-xl font-bold uppercase tracking-wider",
                                currentMode === mode
                                    ? modeButtonActive[mode]
                                    : isLight
                                      ? "bg-gray-100 text-black"
                                      : "bg-white/5 text-white",
                            ]}
                        >
                            {mode}
                        </a>
                    ))
                }
            </div>

            <div class="mt-8 flex justify-center gap-4">
                <ThemeToggle client:visible locale={lang} />
                <LanguageToggle currentLocale={lang} />
            </div>
        </div>
    </div>
</nav>

<script>
    // Audio Toggle Logic
    const audioBtn = document.getElementById("audio-toggle");
    let audioEnabled = localStorage.getItem("audioEnabled") === "true";

    // We can't swap React icons easily in vanilla script without raw SVG manipulation or hiding/showing elements.
    // For simplicity, let's toggle a class or update innerHTML if needed,
    // or just assume the button presence handles the event.
    // Here implies simple logic:

    if (audioBtn) {
        audioBtn.addEventListener("click", () => {
            audioEnabled = !audioEnabled;
            localStorage.setItem("audioEnabled", String(audioEnabled));
            // Dispatch event for other components (like Spline) to listen to
            window.dispatchEvent(
                new CustomEvent("audioToggle", { detail: audioEnabled }),
            );

            // Visual feedback (mock) - ideally swap icon
            audioBtn.style.opacity = audioEnabled ? "1" : "0.5";
        });
    }

    // Mobile Menu Logic
    const menuBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");

    if (menuBtn && mobileMenu) {
        menuBtn.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
        });
    }
</script>
