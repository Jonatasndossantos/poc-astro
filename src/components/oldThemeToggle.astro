---
import { getIntlayer } from "intlayer";

interface Props {
    currentLocale?: string;
}

const { currentLocale: propLocale } = Astro.props;
const content = getIntlayer("theme", propLocale);
console.log(content);
const themesList = Object.keys(content.themes).map((key) => ({
    name: key,
    label: content.themes[key as keyof typeof content.themes],
}));
---

<div title="Change Theme" class="dropdown dropdown-end block">
    <div
        tabindex="0"
        role="button"
        class="btn group btn-sm gap-1.5 px-1.5 btn-ghost"
        aria-label="Change Theme"
    >
        <div
            class="bg-base-100 group-hover:border-base-content/20 border-base-content/10 grid shrink-0 grid-cols-2 gap-0.5 rounded-md border p-1 transition-colors"
        >
            <div class="bg-base-content size-1 rounded-full"></div>
            <div class="bg-primary size-1 rounded-full"></div>
            <div class="bg-secondary size-1 rounded-full"></div>
            <div class="bg-accent size-1 rounded-full"></div>
        </div>
        <svg
            width="12px"
            height="12px"
            class="mt-px hidden size-2 fill-current opacity-60 sm:inline-block"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 2048 2048"
        >
            <path d="M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z"
            ></path>
        </svg>
    </div>
    <div
        tabindex="0"
        class="dropdown-content bg-base-200 text-base-content rounded-box top-px max-h-[calc(100vh-10rem)] w-56 overflow-y-auto border-[length:var(--border)] border-white/5 shadow-2xl outline-[length:var(--border)] outline-black/5 mt-16"
    >
        <ul class="menu menu-sm gap-1">
            <li class="menu-title px-2 py-1 text-xs font-medium opacity-70">
                {content.label}
            </li>
            {
                themesList.map((theme) => (
                    <li>
                        <button
                            class="theme-controller justify-start gap-3 px-2 font-normal hover:bg-base-content/10"
                            data-set-theme={theme.name}
                            data-act-class="!bg-base-content/10 [&_svg]:visible"
                        >
                            <div
                                data-theme={theme.name}
                                class="bg-base-100 grid shrink-0 grid-cols-2 gap-0.5 rounded-md p-0.5 shadow-sm"
                            >
                                <div class="bg-base-content size-1 rounded-full" />
                                <div class="bg-primary size-1 rounded-full" />
                                <div class="bg-secondary size-1 rounded-full" />
                                <div class="bg-accent size-1 rounded-full" />
                            </div>
                            <div class="w-full truncate text-start">
                                {theme.label}
                            </div>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                                class="invisible h-3 w-3 shrink-0 opacity-70"
                            >
                                <path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z" />
                            </svg>
                        </button>
                    </li>
                ))
            }
        </ul>
    </div>
</div>

<script is:inline>
    // 1. Initialize theme from localStorage or system preference
    const storageKey = "theme";
    const defaultTheme = "light";

    function getTheme() {
        if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem(storageKey)
        ) {
            return localStorage.getItem(storageKey);
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            return "dark";
        }
        return defaultTheme;
    }

    function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(storageKey, theme);

        // Update active state in dropdown
        const buttons = document.querySelectorAll("[data-set-theme]");
        buttons.forEach((btn) => {
            if (btn.getAttribute("data-set-theme") === theme) {
                btn.classList.add("!bg-base-content/10");
                const icon = btn.querySelector("svg.invisible");
                if (icon) icon.classList.remove("invisible");
            } else {
                btn.classList.remove("!bg-base-content/10");
                const icon = btn.querySelector("svg");
                if (icon && !icon.classList.contains("invisible")) {
                    // Re-add invisible if it's the checkmark icon
                    if (
                        icon.parentElement === btn &&
                        icon.classList.contains("shrink-0")
                    ) {
                        icon.classList.add("invisible");
                    }
                }
            }
        });
    }

    // Initialize
    setTheme(getTheme());

    // 2. Handle click events
    document.addEventListener("astro:page-load", () => {
        // Re-run setup on page navigation (if ViewTransitions are used)
        const currentTheme = getTheme();
        setTheme(currentTheme);

        const buttons = document.querySelectorAll("[data-set-theme]");
        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const newTheme = btn.getAttribute("data-set-theme");
                setTheme(newTheme);
                // Optional: Close dropdown after selection
                if (document.activeElement instanceof HTMLElement) {
                    document.activeElement.blur();
                }
            });
        });
    });

    // Initial run for first load (in case astro:page-load doesn't fire immediately or ViewTransitions aren't used)
    const buttons = document.querySelectorAll("[data-set-theme]");
    buttons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const newTheme = btn.getAttribute("data-set-theme");
            setTheme(newTheme);
            // Close dropdown by blurring the focus
            const dropdown = btn.closest(".dropdown");
            if (dropdown) {
                const toggle = dropdown.querySelector('[role="button"]');
                if (toggle) toggle.blur();
            }
        });
    });
</script>
